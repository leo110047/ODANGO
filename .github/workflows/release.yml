name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
          - platform: macos-latest
            args: --target x86_64-apple-darwin
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Install frontend dependencies
        run: npm ci

      - name: Build and upload to release
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Discord Pet Overlay ${{ github.ref_name }}'
          releaseBody: |
            ## 更新內容

            ### ${{ github.ref_name }}
            - 新增應用程式內更新功能
            - 修正 Windows 上調整寵物垂直位置無效的問題

            ---

            **macOS 用戶請注意**：由於應用程式未經 Apple 簽名，首次安裝後需要到「系統偏好設定 > 安全性與隱私」允許執行，或是按住 Control 鍵點擊應用程式選擇「打開」。
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # 手動上傳 tauri-action 漏掉的 .sig 和 .nsis.zip 檔案
      - name: Upload missing artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Looking for .sig files ==="
          find src-tauri/target -name "*.app.tar.gz.sig" -type f 2>/dev/null || true

          echo "=== Uploading .sig files ==="
          for sig_file in $(find src-tauri/target -name "*.app.tar.gz.sig" -type f 2>/dev/null); do
            echo "Found: $sig_file"
            # 取得檔名
            filename=$(basename "$sig_file")
            # 根據路徑判斷架構
            if [[ "$sig_file" == *"aarch64"* ]]; then
              new_filename="Discord.Pet.Overlay_aarch64.app.tar.gz.sig"
            else
              new_filename="Discord.Pet.Overlay_x64.app.tar.gz.sig"
            fi
            echo "Uploading as: $new_filename"
            gh release upload "${{ github.ref_name }}" "$sig_file#$new_filename" --clobber || true
          done

      - name: Upload missing artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Looking for .nsis.zip and .sig files ==="
          find src-tauri/target -name "*.nsis.zip" -type f 2>/dev/null || true
          find src-tauri/target -name "*.nsis.zip.sig" -type f 2>/dev/null || true

          echo "=== Uploading .nsis.zip files ==="
          for zip_file in $(find src-tauri/target -name "*.nsis.zip" -type f 2>/dev/null); do
            echo "Found: $zip_file"
            filename=$(basename "$zip_file")
            echo "Uploading: $filename"
            gh release upload "${{ github.ref_name }}" "$zip_file" --clobber || true
          done

          echo "=== Uploading .nsis.zip.sig files ==="
          for sig_file in $(find src-tauri/target -name "*.nsis.zip.sig" -type f 2>/dev/null); do
            echo "Found: $sig_file"
            filename=$(basename "$sig_file")
            echo "Uploading: $filename"
            gh release upload "${{ github.ref_name }}" "$sig_file" --clobber || true
          done

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Generate latest.json and publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = context.ref.replace('refs/tags/', '');
            const version = tag.replace('v', '');

            // Find the draft release
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const draftRelease = releases.data.find(r => r.draft && r.tag_name === tag);

            if (!draftRelease) {
              console.log(`No draft release found for ${tag}`);
              return;
            }

            console.log(`Found draft release: ${draftRelease.name}`);
            console.log(`Release ID: ${draftRelease.id}`);

            // Get all assets
            const assets = await github.rest.repos.listReleaseAssets({
              owner,
              repo,
              release_id: draftRelease.id,
              per_page: 100
            });

            console.log(`\nRelease assets (${assets.data.length}):`);
            for (const asset of assets.data) {
              console.log(`  - ${asset.name}`);
            }

            // Find signature files and read their content
            let darwinAarch64Sig = '';
            let darwinX64Sig = '';
            let windowsSig = '';

            for (const asset of assets.data) {
              if (asset.name.endsWith('.sig')) {
                console.log(`\nReading signature: ${asset.name}`);
                try {
                  const response = await github.request('GET /repos/{owner}/{repo}/releases/assets/{asset_id}', {
                    owner,
                    repo,
                    asset_id: asset.id,
                    headers: {
                      Accept: 'application/octet-stream'
                    }
                  });

                  const sigContent = Buffer.from(response.data).toString('utf-8').trim();
                  console.log(`  Content length: ${sigContent.length}`);
                  console.log(`  Preview: ${sigContent.substring(0, 50)}...`);

                  if (asset.name.includes('aarch64') && asset.name.includes('.app.tar.gz.sig')) {
                    darwinAarch64Sig = sigContent;
                    console.log(`  -> Assigned to darwin-aarch64`);
                  } else if (asset.name.includes('x64') && asset.name.includes('.app.tar.gz.sig')) {
                    darwinX64Sig = sigContent;
                    console.log(`  -> Assigned to darwin-x86_64`);
                  } else if (asset.name.includes('.nsis.zip.sig')) {
                    windowsSig = sigContent;
                    console.log(`  -> Assigned to windows-x86_64`);
                  }
                } catch (err) {
                  console.log(`  Error reading signature: ${err.message}`);
                }
              }
            }

            // Build URLs using the tag (not the draft release URL which uses untagged)
            const baseUrl = `https://github.com/${owner}/${repo}/releases/download/${tag}`;

            // Find the actual filenames from assets
            let darwinAarch64File = '';
            let darwinX64File = '';
            let windowsFile = '';

            for (const asset of assets.data) {
              if (asset.name.includes('aarch64') && asset.name.endsWith('.app.tar.gz')) {
                darwinAarch64File = asset.name;
              } else if (asset.name.includes('x64') && asset.name.endsWith('.app.tar.gz')) {
                darwinX64File = asset.name;
              } else if (asset.name.endsWith('.nsis.zip') && !asset.name.endsWith('.sig')) {
                windowsFile = asset.name;
              }
            }

            const darwinAarch64Url = darwinAarch64File ? `${baseUrl}/${encodeURIComponent(darwinAarch64File)}` : '';
            const darwinX64Url = darwinX64File ? `${baseUrl}/${encodeURIComponent(darwinX64File)}` : '';
            const windowsUrl = windowsFile ? `${baseUrl}/${encodeURIComponent(windowsFile)}` : '';

            console.log(`\nURLs:`);
            console.log(`  darwin-aarch64: ${darwinAarch64Url}`);
            console.log(`  darwin-x86_64: ${darwinX64Url}`);
            console.log(`  windows-x86_64: ${windowsUrl}`);

            console.log(`\nSignatures:`);
            console.log(`  darwin-aarch64: ${darwinAarch64Sig ? 'OK (' + darwinAarch64Sig.length + ' chars)' : 'MISSING'}`);
            console.log(`  darwin-x86_64: ${darwinX64Sig ? 'OK (' + darwinX64Sig.length + ' chars)' : 'MISSING'}`);
            console.log(`  windows-x86_64: ${windowsSig ? 'OK (' + windowsSig.length + ' chars)' : 'MISSING'}`);

            // Create latest.json
            const latestJson = {
              version: version,
              notes: `v${version} 更新`,
              pub_date: new Date().toISOString(),
              platforms: {
                'darwin-aarch64': {
                  signature: darwinAarch64Sig,
                  url: darwinAarch64Url
                },
                'darwin-x86_64': {
                  signature: darwinX64Sig,
                  url: darwinX64Url
                },
                'windows-x86_64': {
                  signature: windowsSig,
                  url: windowsUrl
                }
              }
            };

            console.log(`\nlatest.json:`);
            console.log(JSON.stringify(latestJson, null, 2));

            // Validate before uploading
            const hasMissingSig = !darwinAarch64Sig || !darwinX64Sig || !windowsSig;
            const hasMissingUrl = !darwinAarch64Url || !darwinX64Url || !windowsUrl;

            if (hasMissingSig) {
              console.log('\n⚠️ WARNING: Some signatures are missing!');
            }
            if (hasMissingUrl) {
              console.log('\n⚠️ WARNING: Some URLs are missing!');
            }

            // Upload latest.json as release asset
            const fs = require('fs');
            const latestJsonPath = '/tmp/latest.json';
            fs.writeFileSync(latestJsonPath, JSON.stringify(latestJson, null, 2));

            // Check if latest.json already exists and delete it
            const existingLatestJson = assets.data.find(a => a.name === 'latest.json');
            if (existingLatestJson) {
              await github.rest.repos.deleteReleaseAsset({
                owner,
                repo,
                asset_id: existingLatestJson.id
              });
              console.log('\nDeleted existing latest.json');
            }

            // Upload new latest.json
            const latestJsonContent = fs.readFileSync(latestJsonPath);
            await github.rest.repos.uploadReleaseAsset({
              owner,
              repo,
              release_id: draftRelease.id,
              name: 'latest.json',
              data: latestJsonContent
            });
            console.log('Uploaded latest.json');

            // Publish the release (set draft to false)
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: draftRelease.id,
              draft: false
            });
            console.log(`\n✅ Published release ${tag}`);
